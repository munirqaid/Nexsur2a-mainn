<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الملف الشخصي - Nexora</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700;800&family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .avatar-placeholder-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid white;
            overflow: hidden;
        }
        .banner-placeholder {
            width: 100%;
            height: 300px;
            background: linear-gradient(135deg, #2A7CFF 0%, #A259FF 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- الشريط العلوي الثابت -->
    <header class="navbar">
        <div class="navbar-container">
            <div class="navbar-icons-left">
                <a href="index.html" class="nav-icon-btn" title="الرئيسية">
                    <i class="fas fa-arrow-right"></i>
                </a>
                <div class="logo" title="Nexora - Your World. Smarter.">
                    <span>الملف الشخصي</span>
                </div>
            </div>

            <div class="navbar-icons-right">
                <button class="nav-icon-btn" title="الإشعارات" id="notificationsBtn">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notificationBadge">0</span>
                </button>
                <a href="profile.html" class="nav-icon-btn" title="الملف الشخصي" id="profileBtn">
                    <i class="fas fa-user"></i>
                </a>
                <button class="nav-icon-btn" title="الإعدادات" id="settingsBtn">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="nav-icon-btn" title="تسجيل الخروج" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- المحتوى الرئيسي -->
    <main class="main-container">
        <div class="profile-page-wrapper">
            
            <!-- قسم معلومات الملف الشخصي -->
            <section class="profile-info-section">
                <div class="profile-banner-container">
                    <div id="bannerWrapper" class="banner-placeholder">
                        <img src="" alt="Banner" class="profile-banner" id="profileBanner" style="display:none;" onerror="this.style.display='none';">
                    </div>
                    <button class="edit-banner-btn" id="editBannerBtn" title="تغيير الخلفية">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                
                <div class="profile-details-header">
                    <div class="profile-avatar-container">
                        <div class="avatar-placeholder-large">
                            <img src="" alt="Avatar" class="profile-avatar" id="profileAvatar" style="display:none;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="default-avatar-icon-large" style="display:flex; font-size: 3rem;"><i class="fas fa-user" style="color:#ccc;"></i></div>
                        </div>
                        <button class="edit-avatar-btn" id="editAvatarBtn" title="تغيير الصورة">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    
                    <div class="profile-text-info">
                        <h2 id="profileName">جارٍ التحميل...</h2>
                        <p class="profile-username"></p>
                        <p class="profile-bio" id="profileBio"></p>
                        
                        <div class="profile-stats">
                            <div class="stat">
                                <span class="stat-number" id="followersCount">0</span>
                                <span class="stat-label">متابع</span>
                            </div>
                            <div class="stat">
                                <span class="stat-number" id="followingCount">0</span>
                                <span class="stat-label">متابَع</span>
                            </div>
                            <div class="stat">
                                <span class="stat-number" id="postCount">0</span>
                                <span class="stat-label">منشور</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary edit-profile-btn" id="editProfileBtn">
                            <i class="fas fa-edit"></i>
                            <span>تعديل الملف الشخصي</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- قسم منشورات المستخدم -->
            <section class="user-posts-section">
                <h3 class="section-title">منشوراتي السابقة</h3>
                <div class="feed-section" id="userFeedSection">
                    <!-- منشورات المستخدم سيتم تحميلها هنا -->
                </div>
            </section>
        </div>
    </main>

    <!-- Modal لتعديل الملف الشخصي -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content edit-profile-modal">
            <div class="modal-header">
                <h2>تعديل الملف الشخصي</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="edit-profile-body">
                <div class="setting-item">
                    <label for="editNameInput">الاسم</label>
                    <input type="text" id="editNameInput" value="">
                </div>
                <div class="setting-item">
                    <label for="editBioTextarea">الوصف / Bio</label>
                    <textarea id="editBioTextarea" rows="3"></textarea>
                </div>
                <button class="btn btn-primary" id="saveProfileChangesBtn">حفظ التغييرات</button>
            </div>
        </div>
    </div>

    <!-- حقول إدخال ملف مخفية -->
    <input type="file" id="avatarFileInput" accept="image/*" style="display: none;">
    <input type="file" id="bannerFileInput" accept="image/*" style="display: none;">

    <script src="script.js"></script>
    <script>
        // منطق خاص بصفحة الملف الشخصي (Profile)
        const editProfileBtn = document.getElementById("editProfileBtn");
        const editProfileModal = document.getElementById("editProfileModal");
        const avatarFileInput = document.getElementById("avatarFileInput");
        const bannerFileInput = document.getElementById("bannerFileInput");
        const saveProfileChangesBtn = document.getElementById("saveProfileChangesBtn");

        if (editProfileBtn) {
            editProfileBtn.onclick = () => editProfileModal.classList.add("active");
        }

        document.getElementById("editAvatarBtn").onclick = () => avatarFileInput.click();
        document.getElementById("editBannerBtn").onclick = () => bannerFileInput.click();

        // تحديث بيانات الملف الشخصي من الخادم والتخزين المحلي
        async function updateProfileUI() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user) return;

            document.getElementById('profileName').innerText = user.displayName || user.username;
            document.querySelector('.profile-username').innerText = '@' + user.username;
            document.getElementById('profileBio').innerText = user.bio || 'لا يوجد وصف حالياً';
            
            const avatarImg = document.getElementById('profileAvatar');
            const avatarPlaceholder = document.querySelector('.default-avatar-icon-large');
            if (user.avatarUrl) {
                avatarImg.src = user.avatarUrl;
                avatarImg.style.display = 'block';
                avatarPlaceholder.style.display = 'none';
            } else {
                avatarImg.style.display = 'none';
                avatarPlaceholder.style.display = 'flex';
            }

            const bannerImg = document.getElementById('profileBanner');
            const bannerWrapper = document.getElementById('bannerWrapper');
            if (user.bannerUrl) {
                bannerImg.src = user.bannerUrl;
                bannerImg.style.display = 'block';
                bannerWrapper.classList.remove('banner-placeholder');
            } else {
                bannerImg.style.display = 'none';
                bannerWrapper.classList.add('banner-placeholder');
            }
            
            document.getElementById('editNameInput').value = user.displayName || '';
            document.getElementById('editBioTextarea').value = user.bio || '';
            
            document.getElementById('followersCount').innerText = user.followers ? user.followers.length : 0;
            document.getElementById('followingCount').innerText = user.following ? user.following.length : 0;
            
            // جلب عدد المنشورات الحقيقي
            try {
                const res = await fetch(`/api/posts/user/${user.id || user._id}`);
                const data = await res.json();
                document.getElementById('postCount').innerText = data.posts ? data.posts.length : 0;
            } catch (e) { console.error(e); }
        }

        // معالجة رفع الصورة الشخصية فور اختيارها
        avatarFileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            await uploadProfileMedia(file, 'avatar');
        };

        // معالجة رفع صورة الغلاف فور اختيارها
        bannerFileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            await uploadProfileMedia(file, 'banner');
        };

        async function uploadProfileMedia(file, type) {
            const user = JSON.parse(localStorage.getItem('user'));
            const formData = new FormData();
            formData.append(type, file);

            try {
                const res = await fetch(`/api/users/${user.id || user._id}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: formData
                });
                if (res.ok) {
                    const data = await res.json();
                    localStorage.setItem('user', JSON.stringify(data.user));
                    updateProfileUI();
                    alert('تم تحديث الصورة بنجاح');
                }
            } catch (e) { alert('فشل رفع الصورة'); }
        }

        saveProfileChangesBtn.onclick = async () => {
            const user = JSON.parse(localStorage.getItem('user'));
            const displayName = document.getElementById('editNameInput').value;
            const bio = document.getElementById('editBioTextarea').value;

            try {
                const res = await fetch(`/api/users/${user.id || user._id}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}` 
                    },
                    body: JSON.stringify({ displayName, bio })
                });
                if (res.ok) {
                    const data = await res.json();
                    localStorage.setItem('user', JSON.stringify(data.user));
                    updateProfileUI();
                    editProfileModal.classList.remove('active');
                    alert('تم تحديث البيانات بنجاح');
                }
            } catch (e) { alert('فشل تحديث البيانات'); }
        };

        window.addEventListener("load", updateProfileUI);
    </script>
</body>
</html>
